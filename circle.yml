machine:
  environment:
    HUGO_VERSION: "0.19"
    DOCKERCLOUD_STACK: "${CIRCLE_BRANCH}-${CIRCLE_SHA1:0:7}"
    HUGO_BASE_URL: "http://0.0.0.0:1313"
    HUGO_BIN_URL: "https://github.com/spf13/hugo/releases/download/v${HUGO_VERSION}/hugo_${HUGO_VERSION}_Linux-64bit.tar.gz"
  override:
    - echo $HUGO_BIN_URL
    - sudo apt-get update; sudo apt-get install -yy --no-install-recommends wget
    - wget --no-check-certificate $HUGO_BIN_URL -O hugo.tar.gz
    - tar -xvf hugo.tar.gz
    - sudo cp hugo_${HUGO_VERSION}_linux_amd64/hugo_${HUGO_VERSION}_linux_amd64 /bin/hugo
dependencies:
  pre:
    - pip install docker-cloud

test:
  override:
    - cd ~/oguya.github.io-site-content
    - hugo -d .

#  post:
#    - sed -i "s/PUT_YOUR_BRANCH_TAG_HERE/$CIRCLE_BRANCH/;s/PUT_RANDOM_PORT_HERE://" docker-cloud.yml

deployment:
  production:
    branch: master
    commands:
      - docker-cloud stack create --name=${CIRCLE_BRANCH}-${CIRCLE_SHA1:0:7} -f docker-cloud.yml && docker-cloud stack start ${DOCKERCLOUD_STACK}
